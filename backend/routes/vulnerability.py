from flask import Blueprint, request, jsonify, send_file
import requests
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
import datetime
import os

from utils.dashboard_updater import update_dashboard

vulnerability_bp = Blueprint("vulnerability", __name__)

REPORT_DIR = "reports"
os.makedirs(REPORT_DIR, exist_ok=True)


def scan_website(url):
    vulnerabilities = []
    score = 100

    try:
        response = requests.get(url, timeout=5)
        headers = response.headers

        # HTTPS check
        if not url.startswith("https://"):
            vulnerabilities.append({
                "name": "Insecure HTTP",
                "severity": "High",
                "impact": "Data can be intercepted",
                "fix": "Use HTTPS with SSL certificate"
            })
            score -= 25

        # Security headers
        if "Content-Security-Policy" not in headers:
            vulnerabilities.append({
                "name": "Missing Content-Security-Policy",
                "severity": "Medium",
                "impact": "XSS attacks possible",
                "fix": "Add CSP header"
            })
            score -= 15

        if "X-Frame-Options" not in headers:
            vulnerabilities.append({
                "name": "Missing X-Frame-Options",
                "severity": "Medium",
                "impact": "Clickjacking possible",
                "fix": "Add X-Frame-Options header"
            })
            score -= 10

        if "Server" in headers:
            vulnerabilities.append({
                "name": "Server Information Disclosure",
                "severity": "Low",
                "impact": "Server type exposed",
                "fix": "Hide server version info"
            })
            score -= 5

    except Exception as e:
        return None, str(e)

    score = max(score, 0)

    if score >= 80:
        risk = "LOW"
    elif score >= 50:
        risk = "MEDIUM"
    else:
        risk = "HIGH"
        update_dashboard(report["risk"], report["score"])


    return {
        "url": url,
        "score": score,
        "risk": risk,
        "vulnerabilities": vulnerabilities
    }, None


def generate_pdf(report):
    filename = f"Vulnerability_Report_{int(datetime.datetime.now().timestamp())}.pdf"
    filepath = os.path.join(REPORT_DIR, filename)

    c = canvas.Canvas(filepath, pagesize=A4)
    width, height = A4

    y = height - 50
    c.setFont("Helvetica-Bold", 16)
    c.drawString(50, y, "RakshaNetra â€“ Vulnerability Scan Report")

    y -= 30
    c.setFont("Helvetica", 12)
    c.drawString(50, y, f"Target URL: {report['url']}")
    y -= 20
    c.drawString(50, y, f"Scan Date: {datetime.datetime.now()}")
    y -= 20
    c.drawString(50, y, f"Security Score: {report['score']}/100")
    y -= 20
    c.drawString(50, y, f"Risk Level: {report['risk']}")

    y -= 30
    c.setFont("Helvetica-Bold", 13)
    c.drawString(50, y, "Detected Vulnerabilities:")

    y -= 20
    c.setFont("Helvetica", 11)

    if not report["vulnerabilities"]:
        c.drawString(50, y, "No critical vulnerabilities found.")
    else:
        for v in report["vulnerabilities"]:
            c.drawString(50, y, f"- {v['name']} ({v['severity']})")
            y -= 15
            c.drawString(70, y, f"Impact: {v['impact']}")
            y -= 15
            c.drawString(70, y, f"Fix: {v['fix']}")
            y -= 25

    y -= 20
    c.setFont("Helvetica-Oblique", 9)
    c.drawString(50, y, "Disclaimer: This scan is passive and does not exploit vulnerabilities.")

    c.save()
    return filename


@vulnerability_bp.route(
    "/scan-vulnerability",
    methods=["POST"],
    endpoint="scan_vulnerability_api"
)
def scan():
    data = request.get_json() or {}
    url = data.get("url")

    report, error = scan_website(url)
    if error:
        return jsonify({"error": error}), 400

    pdf_file = generate_pdf(report)


    return jsonify({
        "report": report,
        "pdf": pdf_file
    })


@vulnerability_bp.route(
    "/download-report",
    methods=["GET"],
    endpoint="download_vulnerability_report"
)
def download():
    filename = request.args.get("file")
    filepath = os.path.join(REPORT_DIR, filename)

    return send_file(filepath, as_attachment=True)
