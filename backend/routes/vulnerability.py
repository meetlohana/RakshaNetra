from flask import Blueprint, request, jsonify, send_file
import requests
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
import datetime
import os

from utils.dashboard_updater import update_dashboard

vulnerability_bp = Blueprint("vulnerability", __name__)

REPORT_DIR = "reports"
os.makedirs(REPORT_DIR, exist_ok=True)


# ===============================
# HELPERS
# ===============================
def normalize_url(url):
    if not url.startswith(("http://", "https://")):
        url = "http://" + url
    return url.rstrip("/")


# ===============================
# SCANNER
# ===============================
def scan_website(url):
    if not url:
        return None, "URL is required"

    url = normalize_url(url)
    vulnerabilities = []
    score = 100

    try:
        response = requests.get(url, timeout=5)
        headers = response.headers
        content = response.text.lower()

        # 1ï¸âƒ£ HTTPS
        if not url.startswith("https://"):
            vulnerabilities.append({
                "name": "Insecure HTTPS Configuration",
                "severity": "High",
                "impact": "Data interception possible",
                "fix": "Enable HTTPS using SSL/TLS"
            })
            score -= 15

        # 2ï¸âƒ£ SQL Injection (Passive)
        if any(e in content for e in ["sql syntax", "mysql", "sqlite", "syntax error"]):
            vulnerabilities.append({
                "name": "Possible SQL Injection",
                "severity": "High",
                "impact": "Database exposure risk",
                "fix": "Use parameterized queries"
            })
            score -= 15

        # 3ï¸âƒ£ XSS
        if "Content-Security-Policy" not in headers:
            vulnerabilities.append({
                "name": "Possible XSS Vulnerability",
                "severity": "Medium",
                "impact": "Script injection possible",
                "fix": "Add CSP header"
            })
            score -= 10

        # 4ï¸âƒ£ Security Headers
        for h in ["X-Content-Type-Options", "Referrer-Policy", "Strict-Transport-Security"]:
            if h not in headers:
                vulnerabilities.append({
                    "name": f"Missing {h}",
                    "severity": "Low",
                    "impact": "Reduced protection",
                    "fix": f"Add {h} header"
                })
                score -= 5

        # 5ï¸âƒ£ Clickjacking
        if "X-Frame-Options" not in headers:
            vulnerabilities.append({
                "name": "Clickjacking Vulnerability",
                "severity": "Medium",
                "impact": "UI redress attack possible",
                "fix": "Add X-Frame-Options"
            })
            score -= 10

        # 6ï¸âƒ£ Admin Panel Exposure
        for path in ["/admin", "/login", "/administrator"]:
            try:
                r = requests.get(url + path, timeout=3)
                if r.status_code == 200:
                    vulnerabilities.append({
                        "name": "Admin Panel Exposure",
                        "severity": "High",
                        "impact": f"Accessible at {path}",
                        "fix": "Restrict admin access"
                    })
                    score -= 10
                    break
            except:
                pass

        # 7ï¸âƒ£ Directory Listing
        for d in ["/uploads/", "/backup/"]:
            try:
                r = requests.get(url + d, timeout=3)
                if "index of" in r.text.lower():
                    vulnerabilities.append({
                        "name": "Directory Listing Enabled",
                        "severity": "Medium",
                        "impact": "Sensitive files exposed",
                        "fix": "Disable directory listing"
                    })
                    score -= 10
            except:
                pass

        # 8ï¸âƒ£ robots.txt
        try:
            r = requests.get(url + "/robots.txt", timeout=3)
            if r.status_code == 200 and "disallow" in r.text.lower():
                vulnerabilities.append({
                    "name": "robots.txt Information Disclosure",
                    "severity": "Low",
                    "impact": "Sensitive paths exposed",
                    "fix": "Review robots.txt"
                })
                score -= 5
        except:
            pass

        # 9ï¸âƒ£ Server Header
        if "Server" in headers:
            vulnerabilities.append({
                "name": "Server Information Disclosure",
                "severity": "Low",
                "impact": "Server details exposed",
                "fix": "Hide server header"
            })
            score -= 5

        # ðŸ”Ÿ Open Ports (Simulated)
        vulnerabilities.append({
            "name": "Open Ports Exposure (Simulated)",
            "severity": "Low",
            "impact": "Unused ports may be open",
            "fix": "Close unused ports"
        })
        score -= 5

    except Exception as e:
        return None, f"Scan failed: {str(e)}"

    score = max(score, 0)
    risk = "LOW" if score >= 70 else "MEDIUM" if score >= 40 else "HIGH"

    update_dashboard(risk, score)

    return {
        "url": url,
        "score": score,
        "risk": risk,
        "vulnerabilities": vulnerabilities
    }, None


# ===============================
# PDF GENERATOR  âœ… FIXED
# ===============================
def generate_pdf(report):
    filename = f"RakshaNetra_Report_{int(datetime.datetime.now().timestamp())}.pdf"
    filepath = os.path.join(REPORT_DIR, filename)

    c = canvas.Canvas(filepath, pagesize=A4)
    width, height = A4

    y = height - 50
    c.setFont("Helvetica-Bold", 20)
    c.drawString(50, y, "RakshaNetra Vulnerability Report")

    y -= 30
    c.setFont("Helvetica", 11)
    c.drawString(50, y, f"Target URL: {report['url']}")
    y -= 15
    c.drawString(50, y, f"Score: {report['score']} / 100")
    y -= 15
    c.drawString(50, y, f"Risk Level: {report['risk']}")

    y -= 30
    c.setFont("Helvetica-Bold", 14)
    c.drawString(50, y, "Detected Vulnerabilities")

    y -= 20
    c.setFont("Helvetica", 10)

    for v in report["vulnerabilities"]:
        if y < 100:
            c.showPage()
            y = height - 50
            c.setFont("Helvetica", 10)

        c.drawString(60, y, f"- {v['name']} ({v['severity']})")
        y -= 14
        c.drawString(80, y, f"Impact: {v['impact']}")
        y -= 14
        c.drawString(80, y, f"Fix: {v['fix']}")
        y -= 20

    c.save()
    return filename


# ===============================
# ROUTES
# ===============================
@vulnerability_bp.route("/scan-vulnerability", methods=["POST"])
def scan():
    try:
        data = request.get_json(silent=True) or {}
        url = data.get("url")

        report, error = scan_website(url)
        if error:
            return jsonify({"error": error}), 400

        pdf_file = generate_pdf(report)

        return jsonify({
            "report": report,
            "pdf": pdf_file
        })

    except Exception as e:
        print("âŒ SCAN ERROR:", e)
        return jsonify({"error": "Internal server error"}), 500


@vulnerability_bp.route("/download-report", methods=["GET"])
def download():
    filename = request.args.get("file")
    filepath = os.path.join(REPORT_DIR, filename)

    if not os.path.exists(filepath):
        return jsonify({"error": "File not found"}), 404

    return send_file(filepath, as_attachment=True)
